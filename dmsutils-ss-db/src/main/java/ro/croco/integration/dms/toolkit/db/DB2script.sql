
-- DROP TABLE DM_TYPES;
CREATE TABLE DM_TYPES
(
  ID_TYPE BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 2, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
	NAME VARCHAR(50) NOT NULL,
	BASE_TYPE VARCHAR(50) NOT NULL CHECK (BASE_TYPE IN ('FOLDER', 'DOCUMENT')),
	PARENT_ID_TYPE BIGINT,
	PRIMARY KEY (ID_TYPE)
);
CREATE UNIQUE INDEX DM_TYPES_IDX01 ON DM_TYPES ( NAME ASC ) ALLOW REVERSE SCANS COMPRESS NO;
CREATE INDEX DM_TYPES_IDX02 ON DM_TYPES ( BASE_TYPE ASC ) ALLOW REVERSE SCANS COMPRESS NO;

INSERT INTO DM_TYPES(ID_TYPE, NAME, BASE_TYPE, PARENT_ID_TYPE)
		VALUES(0, 'FOLDER', 'FOLDER', NULL);
INSERT INTO DM_TYPES(ID_TYPE, NAME, BASE_TYPE, PARENT_ID_TYPE)
		VALUES(1, 'DOCUMENT', 'DOCUMENT', NULL);

-- SELECT O.*, NVL(3, 2) FROM DM_OBJECTS O
-- DROP TABLE DM_OBJECTS
CREATE TABLE DM_OBJECTS
(
    ID_OBJECT BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
	  ID_TYPE BIGINT NOT NULL,
    BASE_ID_TYPE BIGINT NOT NULL CHECK (BASE_ID_TYPE IN (0, 1)),
    OBJ_PATH VARCHAR(3000) NOT NULL,
    OBJ_NAME VARCHAR(255) NOT NULL,
	PRIMARY KEY (ID_OBJECT)
);
ALTER TABLE DM_OBJECTS ADD CONSTRAINT DM_OBJECTS_FK01 FOREIGN KEY (ID_TYPE)
  REFERENCES DM_TYPES (ID_TYPE)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
    ENFORCED
    ENABLE QUERY OPTIMIZATION;
ALTER TABLE DM_OBJECTS ADD CONSTRAINT DM_OBJECTS_FK02 FOREIGN KEY (BASE_ID_TYPE)
  REFERENCES DM_TYPES (ID_TYPE)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
    ENFORCED
    ENABLE QUERY OPTIMIZATION;
CREATE INDEX DM_OBJECTS_IDX01 ON DM_OBJECTS ( ID_TYPE ASC ) ALLOW REVERSE SCANS COMPRESS NO;
CREATE INDEX DM_OBJECTS_IDX02 ON DM_OBJECTS ( BASE_ID_TYPE ASC ) ALLOW REVERSE SCANS COMPRESS NO;
CREATE UNIQUE INDEX DM_OBJECTS_IDX03 ON DM_OBJECTS ( OBJ_PATH ASC, OBJ_NAME ASC ) ALLOW REVERSE SCANS COMPRESS NO;

--  DROPTABLE DM_OBJECT_VERSIONS
CREATE TABLE DM_OBJECT_VERSIONS
(
    ID_VERSION BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
	  ID_OBJECT BIGINT NOT NULL,
    ID_VERSION_COUNTER INTEGER,
    ID_VERSION_LABEL VARCHAR(50),
	  PRIMARY KEY (ID_VERSION)
);
ALTER TABLE DM_OBJECT_VERSIONS ADD CONSTRAINT DM_OBJECT_VERSIONS_FK01 FOREIGN KEY (ID_OBJECT)
  REFERENCES DM_OBJECTS (ID_OBJECT)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
    ENFORCED
    ENABLE QUERY OPTIMIZATION;

-- SELECT S.*, LENGTH(S.STREAM_CONTENT) FROM DM_VERSION_STREAMS S
-- DROP TABLE DM_VERSION_STREAMS
CREATE TABLE DM_VERSION_STREAMS
(
    --ID_STREAM BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
    ID_VERSION BIGINT NOT NULL,
    NAME VARCHAR(255) NOT NULL, --filename with extension
    MIME_TYPE VARCHAR(255) NOT NULL,
    TYPE VARCHAR(50) NOT NULL CHECK (TYPE IN ('INTERNAL', 'EXTERNAL')),
    STREAM_CONTENT BLOB(500M)	 INLINE LENGTH 1000 LOGGED NOT COMPACT,
    STREAM_REFERENCE VARCHAR(4000),
    STREAM_SIZE BIGINT, --length in bytes
    PRIMARY KEY (ID_VERSION)
);
--CREATE UNIQUE INDEX DM_VERSION_STREAMS_IDX01 ON DM_VERSION_STREAMS (ID_VERSION);


-- SELECT * FROM DM_PROPERTY_TYPES
-- DELETE FROM DM_PROPERTY_TYPES
-- DROP TABLE DM_PROPERTY_TYPES
CREATE TABLE DM_PROPERTY_TYPES
(
    ID_PROPERTY_TYPE BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1000, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
    NAME VARCHAR(50),
    PRIMARY KEY (ID_PROPERTY_TYPE)
);
CREATE UNIQUE INDEX DM_PROPERTY_TYPES_IDX01 ON DM_PROPERTY_TYPES ( NAME ASC ) ALLOW REVERSE SCANS COMPRESS NO;

INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(1, 'STRING');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(2, 'BYTE');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(3, 'SHORT');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(4, 'INTEGER');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(5, 'LONG');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(6, 'FLOAT');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(7, 'DOUBLE');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(8, 'CHARACTER');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(9, 'BOOLEAN');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(10, 'BIGDECIMAL');
INSERT INTO DM_PROPERTY_TYPES (ID_PROPERTY_TYPE, NAME)
    VALUES(11, 'BIGINTEGER');

-- SELECT * FROM DM_VERSION_PROPERTIES
-- DROP TABLE DM_VERSION_PROPERTIES
-- DELETE FROM DM_VERSION_PROPERTIES
CREATE TABLE DM_VERSION_PROPERTIES
(
    ID_PROPERTY BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
    ID_VERSION BIGINT NOT NULL,
    PROPERTY_NAME VARCHAR(255) NOT NULL,
    ID_PROPERTY_TYPE BIGINT NOT NULL,
    PROPERTY_VALUE VARCHAR(4000),
    PRIMARY KEY (ID_PROPERTY)
);
ALTER TABLE DM_VERSION_PROPERTIES ADD CONSTRAINT DM_VERSION_PROPERTIES_FK01 FOREIGN KEY (ID_PROPERTY_TYPE)
  REFERENCES DM_PROPERTY_TYPES (ID_PROPERTY_TYPE)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
    ENFORCED
    ENABLE QUERY OPTIMIZATION;
CREATE UNIQUE INDEX DM_VERSION_PROPERTIES_IDX01 ON DM_VERSION_PROPERTIES ( ID_VERSION ASC, PROPERTY_NAME ) ALLOW REVERSE SCANS COMPRESS NO;

-- SELECT * FROM DM_ORPHAN_STREAMS
-- DROP TABLE DM_ORPHAN_STREAMS
CREATE TABLE DM_ORPHAN_STREAMS
(
    ID_ORPHAN_STREAM BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1, CACHE 20, NO MINVALUE, NO MAXVALUE, NO CYCLE, NO ORDER),
    STREAM_REFERENCE VARCHAR(4000) NOT NULL,
    CREATE_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    RETRY_COUNT INT DEFAULT 5,
    PRIMARY KEY (STREAM_REFERENCE)
);
CREATE INDEX DM_ORPHAN_STREAMS_IDX01 ON DM_ORPHAN_STREAMS ( UPDATE_TIME ) ALLOW REVERSE SCANS COMPRESS NO;
