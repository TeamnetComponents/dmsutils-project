<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:jdbc="http://www.springframework.org/schema/integration/jdbc"

       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-4.0.xsd
       http://www.springframework.org/schema/integration/jdbc http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc-4.0.xsd">

    <int:poller id="jdbcPoller" fixed-rate="5000"/>
    <int:channel id="syncRequestBatchChannel"/>
    <int:channel id="requestBatchSplitterChannel"/>
    <int:channel id="asyncSingleRequestProcessChannel">
        <int:dispatcher task-executor="singleRequestProcessExecutor"/>
    </int:channel>
    <int:channel id="syncResponseChannel"/>

    <jdbc:inbound-channel-adapter id="inboundAdapter"
                                  query="select * from DM_INTEGRATION_REQUEST"
                                  data-source="syncRequestDataSource"
                                  channel="syncRequestBatchChannel">
        <int:poller ref="jdbcPoller"/>
    </jdbc:inbound-channel-adapter>

    <int:service-activator id="channelLinkingSA" ref="jdbcService" method="processRequestBatch"
                           input-channel="syncRequestBatchChannel" output-channel="requestBatchSplitterChannel"/>

    <int:splitter ref="requestBatchSplitterSplitter" input-channel="requestBatchSplitterChannel" output-channel="asyncSingleRequestProcessChannel"/>

    <bean id="requestBatchSplitterSplitter" class="integration.service.JdbcMessageListSplitter"/>

    <bean id="singleRequestProcessExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
        <property name="corePoolSize" value="10"/>
        <property name="queueCapacity" value="100"/>
    </bean>

    <int:service-activator id="responseChannelSA" ref="jdbcService" method="singleRequestProcess"
                           input-channel="asyncSingleRequestProcessChannel" output-channel="syncResponseChannel"/>

    <jdbc:outbound-channel-adapter id="outboundAdapter" data-source="syncResponseDataSource" channel="syncResponseChannel"
                                   query="insert into DM_INTEGRATION_RESPONSE(MSG_ID,MSG_CORRELATION_ID,MSG_DESTINATION,MSG_REPLY_TO,MSG_EXPIRATION,MSG_PRIORITY,MSG_CONTENT,PRC_STATUS,PRC_ID) values
                                                                             (:msg_id,:msg_correlation_id,:msg_destination,:msg_reply_to,:msg_expiration,:msg_priority,:msg_content,:prc_status,:prc_id)"
                                   sql-parameter-source-factory="spelSource"/>

    <bean id="spelSource" class="org.springframework.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory">
        <property name="parameterExpressions">
            <map>
                <entry key="msg_id"               value="123"/>
                <entry key="msg_correlation_id"   value="123"/>
                <entry key="msg_destination"      value="123"/>
                <entry key="msg_reply_to"         value="123"/>
                <entry key="msg_expiration"       value="123"/>
                <entry key="msg_priority"         value="4"/>
                <entry key="msg_content"          value="123"/>
                <entry key="prc_status"           value="123"/>
                <entry key="prc_id"               value="123"/>
            </map>
        </property>
    </bean>

</beans>
